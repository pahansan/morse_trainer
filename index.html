<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тренажёр азбуки Морзе</title>
  <style>
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0f1724;font-family:Arial, sans-serif}
    .card{padding:28px;border-radius:14px;color:#e6eef6;box-shadow:0 6px 30px rgba(2,6,23,0.6);background:#0b1220;text-align:center}
    .big-btn{width:220px;height:220px;border-radius:50%;background:radial-gradient(circle at 30% 20%, #0af, #06b6d4);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(3,10,30,0.6);border:none;outline:none;cursor:pointer;user-select:none}
    .big-btn:active{transform:scale(.995)}
    .big-btn span{font-size:28px;font-weight:700;color:#021827;letter-spacing:1px}
  </style>
</head>
<body>
  <div class="card">
    <button id="toneBtn" class="big-btn" aria-pressed="false"><span>HOLD</span></button>
  </div>

<script>
let ctx = null;
let osc = null;
let gain = null;
let isPlaying = false;

const btn = document.getElementById('toneBtn');
const defaultFreq = 1000;
const defaultAttack = 2; // ms
const defaultDecay = 2; // ms

function ensureContext(){
  if(!ctx){
    ctx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function startTone(){
  if(isPlaying) return;
  ensureContext();

  osc = ctx.createOscillator();
  gain = ctx.createGain();

  osc.type = 'sine';
  osc.frequency.setValueAtTime(defaultFreq, ctx.currentTime);
  gain.gain.setValueAtTime(0.00001, ctx.currentTime);

  osc.connect(gain).connect(ctx.destination);
  osc.start();

  const atk = defaultAttack/1000;
  const now = ctx.currentTime;
  gain.gain.cancelScheduledValues(now);
  gain.gain.setValueAtTime(0.00001, now);
  gain.gain.linearRampToValueAtTime(1.0, now + atk);

  isPlaying = true;
  btn.setAttribute('aria-pressed','true');
}

function stopTone(){
  if(!isPlaying || !ctx) return;
  const now = ctx.currentTime;
  const dec = defaultDecay/1000;

  gain.gain.cancelScheduledValues(now);
  gain.gain.setValueAtTime(gain.gain.value, now);
  gain.gain.linearRampToValueAtTime(0.00001, now + dec);

  // вместо задержки: слушаем событие onended, чтобы гарантировать очистку вовремя
  osc.stop(now + dec + 0.01);
  osc.onended = ()=>{
    try{ osc.disconnect(); gain.disconnect(); }catch(e){}
    osc = null; gain = null; isPlaying = false; btn.setAttribute('aria-pressed','false');
  };
}

btn.addEventListener('pointerdown', (e)=>{
  e.preventDefault();
  ensureContext();
  if(ctx.state === 'suspended') ctx.resume();
  startTone();
});
['pointerup','pointercancel','pointerleave'].forEach(evt => {
  btn.addEventListener(evt, (e)=>{
    e.preventDefault();
    stopTone();
  });
});
document.addEventListener('keydown', (e)=>{
  if(e.code === 'Space' && !e.repeat){
    e.preventDefault();
    ensureContext(); if(ctx.state === 'suspended') ctx.resume(); startTone();
  }
});
document.addEventListener('keyup', (e)=>{
  if(e.code === 'Space'){
    e.preventDefault(); stopTone();
  }
});
</script>
</body>
</html>
